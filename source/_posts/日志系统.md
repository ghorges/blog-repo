---
title: æ—¥å¿—ç³»ç»Ÿ
date: 2020-06-17 03:18:59
tags: [æ•°æ®åº“]
---
# æ—¥å¿—ç³»ç»Ÿï¼šä¸€æ¡SQLæ›´æ–°è¯­å¥æ˜¯å¦‚ä½•æ‰§è¡Œçš„ï¼Ÿ

MySQL å¯ä»¥æ¢å¤åˆ°åŠä¸ªæœˆå†…ä»»æ„ä¸€ç§’çš„çŠ¶æ€ï¼Œè¿™ä¸ªæ˜¯å¦‚ä½•åšåˆ°çš„ï¼Ÿ

é¦–å…ˆåˆ—ä¸¾ä¸€ä¸‹ mysql ä¸­çš„æ—¥å¿—ã€‚

* é”™è¯¯æ—¥å¿—(error log)ï¼šæ•…åæ€æ„ï¼Œè®°å½•é”™è¯¯ä¿¡æ¯ï¼Œå¯åŠ¨ä¿¡æ¯ç­‰ã€‚
* æŸ¥è¯¢æ—¥å¿—ï¼ˆgeneral logï¼‰ï¼šè®°å½•ä¸å®¢æˆ·ç«¯è¿æ¥å’Œæ‰§è¡Œçš„è¯­å¥ã€‚ï¼ˆåŸºæœ¬ä¸ç”¨ï¼‰
* äºŒè¿›åˆ¶æ—¥å¿—ï¼ˆbin logï¼‰ï¼šè®°å½•å¯¹æ•°æ®åº“çš„ä¿®æ”¹æ“ä½œï¼Œæ¢å¤åˆ°ä¹‹å‰çš„çŠ¶æ€ä¹Ÿæ˜¯é€šè¿‡ bin log å®Œæˆçš„ã€‚
* æ…¢æŸ¥è¯¢æ—¥å¿—ï¼ˆslow logï¼‰ï¼šåœ¨å…¬å¸è€æœ‰è¿™ä¸ªé—®é¢˜ï¼Œè®°å½•æ‰€æœ‰æ‰§è¡Œæ—¶é—´è¶…è¿‡ long_query_time çš„æ‰€æœ‰æŸ¥è¯¢æˆ–ä¸ä½¿ç”¨ç´¢å¼•çš„æŸ¥è¯¢ã€‚
* ä¸­ç»§æ—¥å¿—ï¼ˆrelay logï¼‰ï¼šä¸»ä»å¤åˆ¶ä½¿ç”¨çš„æ—¥å¿—ã€‚ï¼ˆä¸€èˆ¬ä½¿ç”¨ bin logï¼‰

## é”™è¯¯æ—¥å¿—

é”™è¯¯æ—¥å¿—å¿…å®šæ˜¯å¼€å¯çš„ã€‚ä½¿ç”¨å‘½ä»¤ï¼š

```sql
show variables like 'log_error';
```

å¯ä»¥æŸ¥çœ‹æ–‡ä»¶çš„æ‰€åœ¨ä½ç½®ï¼Œå¹¶å¯ä»¥æŸ¥çœ‹æ–‡ä»¶ä¿¡æ¯ã€‚

![image-20200617014133683](/images/image-20200617014133683.png)

    ![image-20200617014254047](C:\Users\ma\AppData\Roaming\Typora\typora-user-images\image-20200617014254047.png)

## æŸ¥è¯¢æ—¥å¿—

    æŸ¥è¯¢æ—¥å¿—ä¼šè®°å½•æ‰€æœ‰æ‰§è¡Œè¿‡çš„è¯­å¥ï¼Œä¸å»ºè®®å¼€å¯ï¼ˆé»˜è®¤æ˜¯å…³é—­çš„ï¼‰ã€‚

    è‹¥éœ€è¦å¼€å¯ï¼Œæ‰§è¡Œï¼š

    ```
    set global general_log=on;
    ```

    å¹¶ä¸”å°† log_output æ”¹ä¸º FILEï¼ˆé»˜è®¤ä¸º FILEï¼Œä¸å»ºè®®ä¿®æ”¹ï¼‰ã€‚å³å¯ä½¿ç”¨å‘½ä»¤ï¼š

    ```
    show variables like 'general_log%';
    ```

    æŸ¥çœ‹æ–‡ä»¶ä½ç½®å¹¶æŸ¥çœ‹æ–‡ä»¶ã€‚

    ![image-20200617015105239](C:\Users\ma\AppData\Roaming\Typora\typora-user-images\image-20200617015105239.png)

    ![image-20200617015242131](C:\Users\ma\AppData\Roaming\Typora\typora-user-images\image-20200617015242131.png)

## æ…¢æŸ¥è¯¢æ—¥å¿—

    è®°å½• sql æ‰§è¡Œæ—¶é—´å¤§äº long_query_time çš„æ—¥å¿—ã€‚ï¼ˆlong_query_time ä½¿ç”¨ `show variables like 'long_query_time';`æŸ¥çœ‹ã€‚è‡ªå·±æœåŠ¡å™¨ä¸€èˆ¬é»˜è®¤ä¸º 10sï¼Œå…¬å¸ä¸€èˆ¬ 200 ms+ å°±ç®—è¶…æ—¶äº†ã€‚

    å¯åŠ¨æ…¢æŸ¥è¯¢æ—¥å¿—ä½¿ç”¨ï¼š

    ```
    set global slow_query_log=on;
    ```

    å¹¶ä½¿ç”¨ï¼š

    ```
    show variables like 'slow%';
    ```

    æŸ¥çœ‹æ–‡ä»¶ä½ç½®ã€‚ç„¶åä½¿ç”¨ `select sleep(15);`å°±å¯ä»¥æŸ¥çœ‹åˆ°æ–‡ä»¶è®°å½•äº†è¿™æ¡ä¿¡æ¯ã€‚

    è®°å¾— 5 æœˆä»½åœ¨å…¬å¸è¢«è¿™ä¸ªå‘æƒ¨äº†ï¼Œå¤©å¤©éƒ½æ˜¯æ…¢æŸ¥è¯¢æ—¥æŠ¥ï¼ˆä½†æ˜¯ç¡®å®æ¥è§¦ä¸åˆ°è¿™ä¹ˆåº•å±‚çš„æ—¥å¿—ï¼Œéƒ½æ˜¯ DBA å°è£…å¥½çš„ï¼‰ï¼Œç„¶åä½¿ç”¨`limit(1000)`ä¿®æ”¹ä»£ç ä¸­çš„ sqlï¼Œç°åœ¨æƒ³èµ·æ¥ï¼Œåªæµ®äºè¡¨é¢ï¼Œä¸çœ‹åº•å±‚çš„è¿™äº›ä¸œè¥¿ï¼ŒçœŸæœ‰å¯èƒ½å°±æˆä¸ºä¼ è¯´ä¸­çš„åç«¯ crud å·¥ç¨‹å¸ˆí ½í¸„ã€‚

## äºŒè¿›åˆ¶æ—¥å¿—

    è¿™ä¸ªå°±å°¤ä¸ºé‡è¦äº†ï¼ˆä½†æ˜¯åœ¨å…¬å¸ä»æ¥æ²¡æ¥è§¦è¿‡í ½í¸­ï¼Œä»…ä»…è®°å¾—æœ‰ä¸ªé«˜çº§æ“ä½œï¼šâ€œå½’æ¡£â€å¯ä»¥ä½¿æ•°æ®åº“å¯ç”¨å®¹é‡å˜å¤§ï¼Œä½†æ˜¯ä¸å½±å“ä½¿ç”¨ï¼ŒçŒœæµ‹å°±æ˜¯ä½¿ç”¨äº† bin-log æˆ–è€…æœ‰ä¸€ä¸ªæ›´ä¾¿å®œçš„ç£ç›˜ï¼ŒæŠŠä¸å¸¸ç”¨çš„æ•°æ®å­˜å‚¨åœ¨é‚£ä¸ªç£ç›˜é‡Œï¼‰ã€‚

    äºŒè¿›åˆ¶æ—¥å¿—åŒ…å«äº†**å¼•èµ·æˆ–å¯èƒ½å¼•èµ·æ•°æ®åº“æ”¹å˜**(å¦‚ delete è¯­å¥ä½†æ²¡æœ‰åŒ¹é…è¡Œ)çš„äº‹ä»¶ä¿¡æ¯ï¼Œä½†ç»ä¸ä¼šåŒ…æ‹¬æŸ¥è¯¢è¯­å¥ã€‚

    å…±æœ‰ä¸‰ç§äºŒè¿›åˆ¶æ—¥å¿—çš„å­˜å‚¨æ–¹å¼ï¼š

    * statementï¼šbin-log ä¸­ä¿å­˜çš„éƒ½æ˜¯æ‰§è¡Œè¿‡çš„ sql è¯­å¥ï¼Œä½†æ˜¯å¦‚æœåŒ…å«ä¸»ä»ä½¿ç”¨éšæœºå‡½æ•°çš„ä¿¡æ¯ï¼Œå¯èƒ½é€ æˆä¸»ä»ä¸ä¸€è‡´ã€‚
    * rowï¼šåŸºäºè¡Œçš„æ–¹å¼ï¼Œæ•°æ®ä¸€è‡´æ€§æ–¹é¢æœ€å¯é ã€‚ç¼ºç‚¹æ˜¯æ—¥å¿—é‡å¤§ã€‚
    * mixedï¼šåœ¨ mixed æ¨¡å¼ä¸‹ï¼Œmysql ä¼šæ ¹æ®æ‰§è¡Œçš„æ¯ä¸€æ¡å…·ä½“çš„ sql è¯­å¥æ¥åŒºåˆ†å¯¹å¾…è®°å½•çš„æ—¥å¿—å½¢å¼ï¼Œä¹Ÿå°±æ˜¯åœ¨ statement å’Œ row ä¹‹é—´é€‰æ‹©ä¸€ç§ã€‚

    æˆ‘çš„ç”µè„‘ä½¿ç”¨çš„æ˜¯ mixedã€‚æŸ¥çœ‹æ—¥å¿—ä½ç½®å¯ä»¥ä½¿ç”¨ï¼š`find / -name mysql-bin.000029`ã€‚

    å¼€å¯äºŒè¿›åˆ¶æ—¥å¿—åœ¨ç½‘ä¸Šæœ‰å¾ˆå¤šè¯¦ç»†èµ„æ–™ï¼Œæ•…ä¸åŠ èµ˜è¿°ã€‚

    ç®€å•åˆ†æä¸€ä¸‹ï¼š

    ![image-20200617022111061](C:\Users\ma\AppData\Roaming\Typora\typora-user-images\image-20200617022111061.png)

    è¿™ä¸ªæ˜¯æˆ‘æ‰§è¡Œï¼š

    ```
    insert into T (ID, c) value (2, 333);
    ```

    åæ–°äº§ç”Ÿçš„ä¿¡æ¯ï¼Œ`at 107`-`at 175`æ˜¯è®°å½•äº†ä¸€äº›ä¿¡æ¯ï¼Œ`at 175`-`at 274`æ˜¯æ‰§è¡Œäº† sql æœ€ç»ˆå¹¶ COMMITã€‚ï¼ˆtodoï¼šä¸ªäººçŒœæµ‹æ­¤ BEGIN & COMMIT æ˜¯ mysql ä¸­çš„äº‹åŠ¡ï¼Œå¦‚æœå¤±è´¥åˆ™ä¸ä¼š COMMITï¼Œæœ‰å¾…è€ƒç©¶ã€‚ï¼‰

## ä¸‹é¢ä¸ºå­¦ä¹  redo log å’Œ bin log çš„ç¬”è®°

    redo log æ˜¯ InnoDB å¼•æ“ç‹¬æœ‰çš„ã€‚

    å½“æœ‰ä¸€æ¡è®°å½•éœ€è¦æ›´æ–°çš„æ—¶å€™ï¼ŒInnoDB å¼•æ“å°±ä¼šå…ˆæŠŠè®°å½•å†™åˆ° redo log é‡Œé¢ï¼Œå¹¶æ›´æ–°å†…å­˜ï¼Œè¿™ä¸ªæ—¶å€™æ›´æ–°å°±ç®—å®Œæˆäº†ã€‚åŒæ—¶ï¼ŒInnoDB å¼•æ“ä¼šåœ¨é€‚å½“çš„æ—¶å€™ï¼Œå°†è¿™ä¸ªæ“ä½œè®°å½•æ›´æ–°åˆ°ç£ç›˜é‡Œé¢ï¼Œè€Œè¿™ä¸ªæ›´æ–°å¾€å¾€æ˜¯åœ¨ç³»ç»Ÿæ¯”è¾ƒç©ºé—²çš„æ—¶å€™åšã€‚ï¼ˆredo log è®°å½•çš„æ˜¯è¿™ä¸ªé¡µæœ‰ä»€ä¹ˆæ”¹åŠ¨ï¼Œçœç©ºé—´ï¼Œä½†æ˜¯ä¸æ¸…æ¥šå†…éƒ¨ä½¿ç”¨çš„æ˜¯å¦ä¸º diffã€‚ï¼‰

    InnoDB çš„ redo log æ˜¯å›ºå®šå¤§å°çš„ï¼Œæ¯”å¦‚å¯ä»¥é…ç½®ä¸ºä¸€ç»„ 4 ä¸ªæ–‡ä»¶ï¼Œæ¯ä¸ªæ–‡ä»¶çš„å¤§å°æ˜¯ 1GBï¼Œé‚£ä¹ˆè¿™å—â€œç²‰æ¿â€æ€»å…±å°±å¯ä»¥è®°å½• 4GB çš„æ“ä½œã€‚ä»å¤´å¼€å§‹å†™ï¼Œå†™åˆ°æœ«å°¾å°±åˆå›åˆ°å¼€å¤´å¾ªç¯å†™ï¼Œå¦‚ä¸‹é¢è¿™ä¸ªå›¾æ‰€ç¤ºã€‚

    ![img](https://static001.geekbang.org/resource/image/16/a7/16a7950217b3f0f4ed02db5db59562a7.png)

    write pos æ˜¯å½“å‰è®°å½•çš„ä½ç½®ï¼Œä¸€è¾¹å†™ä¸€è¾¹åç§»ï¼Œå†™åˆ°ç¬¬ 3 å·æ–‡ä»¶æœ«å°¾åå°±å›åˆ° 0 å·æ–‡ä»¶å¼€å¤´ã€‚checkpoint æ˜¯å½“å‰è¦æ“¦é™¤çš„ä½ç½®ï¼Œä¹Ÿæ˜¯å¾€åæ¨ç§»å¹¶ä¸”å¾ªç¯çš„ï¼Œæ“¦é™¤è®°å½•å‰è¦æŠŠè®°å½•æ›´æ–°åˆ°æ•°æ®æ–‡ä»¶ã€‚

    æœ‰äº† redo logï¼ŒInnoDB å°±å¯ä»¥ä¿è¯å³ä½¿æ•°æ®åº“å‘ç”Ÿå¼‚å¸¸é‡å¯ï¼Œä¹‹å‰æäº¤çš„è®°å½•éƒ½ä¸ä¼šä¸¢å¤±ï¼Œè¿™ä¸ªèƒ½åŠ›ç§°ä¸º **crash-safe**ã€‚

    æ³¨ï¼šredo log é»˜è®¤ä¸ºæ–‡ä»¶å­˜å‚¨ï¼Œå¼ºçƒˆä¸å»ºè®®ä¿®æ”¹ã€‚

    MySQL æ•´ä½“æ¥çœ‹ï¼Œå…¶å®å°±æœ‰ä¸¤å—ï¼šä¸€å—æ˜¯ Server å±‚ï¼Œå®ƒä¸»è¦åšçš„æ˜¯ MySQL åŠŸèƒ½å±‚é¢çš„äº‹æƒ…ï¼›è¿˜æœ‰ä¸€å—æ˜¯å¼•æ“å±‚ï¼Œè´Ÿè´£å­˜å‚¨ç›¸å…³çš„å…·ä½“äº‹å®œã€‚ä¸Šé¢æˆ‘ä»¬èŠåˆ°çš„ç²‰æ¿ redo log æ˜¯ InnoDB å¼•æ“ç‰¹æœ‰çš„æ—¥å¿—ï¼Œè€Œ Server å±‚ä¹Ÿæœ‰è‡ªå·±çš„æ—¥å¿—ï¼Œç§°ä¸º binlogï¼ˆå½’æ¡£æ—¥å¿—ï¼‰ã€‚

    æœ€å¼€å§‹ MySQL é‡Œå¹¶æ²¡æœ‰ InnoDB å¼•æ“ã€‚MySQL è‡ªå¸¦çš„å¼•æ“æ˜¯ MyISAMï¼Œä½†æ˜¯ MyISAM æ²¡æœ‰ crash-safe çš„èƒ½åŠ›ï¼Œbinlog æ—¥å¿—åªèƒ½ç”¨äºå½’æ¡£ã€‚è€Œ InnoDB æ˜¯å¦ä¸€ä¸ªå…¬å¸ä»¥æ’ä»¶å½¢å¼å¼•å…¥ MySQL çš„ï¼Œæ—¢ç„¶åªä¾é  binlog æ˜¯æ²¡æœ‰ crash-safe èƒ½åŠ›çš„ï¼Œæ‰€ä»¥ InnoDB ä½¿ç”¨å¦å¤–ä¸€å¥—æ—¥å¿—ç³»ç»Ÿâ€”â€”ä¹Ÿå°±æ˜¯ redo log æ¥å®ç° crash-safe èƒ½åŠ›ã€‚

    è¿™ä¸¤ç§æ—¥å¿—æœ‰ä»¥ä¸‹ä¸‰ç‚¹ä¸åŒã€‚

    * redo log æ˜¯ InnoDB å¼•æ“ç‰¹æœ‰çš„ï¼›binlog æ˜¯ MySQL çš„ Server å±‚å®ç°çš„ï¼Œæ‰€æœ‰å¼•æ“éƒ½å¯ä»¥ä½¿ç”¨ã€‚
    * redo log æ˜¯ç‰©ç†æ—¥å¿—ï¼Œè®°å½•çš„æ˜¯â€œåœ¨æŸä¸ªæ•°æ®é¡µä¸Šåšäº†ä»€ä¹ˆä¿®æ”¹â€ï¼›binlog æ˜¯é€»è¾‘æ—¥å¿—ï¼Œè®°å½•çš„æ˜¯è¿™ä¸ªè¯­å¥çš„åŸå§‹é€»è¾‘ï¼Œæ¯”å¦‚â€œç»™ ID=2 è¿™ä¸€è¡Œçš„ c å­—æ®µåŠ  1 â€ã€‚
    * redo log æ˜¯å¾ªç¯å†™çš„ï¼Œç©ºé—´å›ºå®šä¼šç”¨å®Œï¼›binlog æ˜¯å¯ä»¥è¿½åŠ å†™å…¥çš„ã€‚â€œè¿½åŠ å†™â€æ˜¯æŒ‡ binlog æ–‡ä»¶å†™åˆ°ä¸€å®šå¤§å°åä¼šåˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªï¼Œå¹¶ä¸ä¼šè¦†ç›–ä»¥å‰çš„æ—¥å¿—ã€‚

    sql `mysql> update T set c=c+1 where ID=2;`æ‰§è¡Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

    ![img](https://static001.geekbang.org/resource/image/2e/be/2e5bff4910ec189fe1ee6e2ecc7b4bbe.png)

    è¿™é‡Œä½¿ç”¨äº†**ä¸¤é˜¶æ®µæäº¤**ï¼Œä¸ºä»€ä¹ˆå¿…é¡»ä½¿ç”¨ä¸¤é˜¶æ®µæäº¤ï¼Œå…¶å®å°±æ˜¯ä¿è¯ crash-safeã€‚ï¼ˆå…¶å®å°±æ˜¯äº‹åŠ¡ï¼Œé 0 å³ 1ï¼‰ã€‚

    ä¸ºä»€ä¹ˆåªç”¨ bin log ä¸èƒ½åšåˆ° crash-safeï¼Ÿ

    å‡è®¾å…ˆè½åº“ï¼Œåæäº¤äº‹åŠ¡ï¼Œè½åº“å®Œæ¯•åï¼Œæ•°æ®åº“å´©äº†ï¼Œæ²¡æœ‰ commit äº†ï¼Œä½†æ˜¯ä»åº“æ˜¯æ ¹æ® commit å¤åˆ¶çš„ï¼Œæ­¤æ—¶ä¸»åº“æœ‰è¿™æ¡æ•°æ®ï¼Œä½†æ˜¯ä»åº“æ²¡æœ‰ã€‚å‡è®¾å…ˆæäº¤äº‹åŠ¡åè½åº“ä¹Ÿæ˜¯åŒç†ã€‚



## å¼•ç”¨è¿‡çš„ blog

    [https://www.cnblogs.com/QicongLiang/p/10390435.html](https://www.cnblogs.com/QicongLiang/p/10390435.html)

    [https://blog.csdn.net/keda8997110/article/details/50895171](https://blog.csdn.net/keda8997110/article/details/50895171)

    [https://www.cnblogs.com/f-ck-need-u/p/9001061.html#auto_id_6](https://www.cnblogs.com/f-ck-need-u/p/9001061.html#auto_id_6)

    [https://www.jianshu.com/p/2f1585c7f2f3](https://www.jianshu.com/p/2f1585c7f2f3)

    [æ–‡æœ¬æ¯”è¾ƒå·¥å…·](http://wenbenbijiao.renrensousuo.com/#diff)

    etc.


    ```
    ```
    ```
    ```
    ```
    ```
    ```
    ```
    ```
    ```
